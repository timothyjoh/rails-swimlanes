# Project Status

> Auto-generated by cc-pipeline. Last updated after Phase 2.

## Overview
Swimlanes is a Trello-like board management app built with Rails 8, Hotwire (Turbo + Stimulus), Tailwind CSS, and SQLite. Users will be able to create boards with swimlane columns and draggable cards, with card details, board sharing, real-time updates, and customizable backgrounds.

**Current state:** Users can sign up, log in, create boards, and manage a full board canvas. Each board has swimlane columns that can be added, renamed, and deleted. Cards can be created in any lane, renamed, deleted, and dragged to reorder within a lane or moved to a different lane — with order persisting after reload. All actions are authentication-gated and scoped to the board owner.

---

## Phase 1: Project Setup, Authentication, and Board CRUD

### What We Built
- Rails 8 app scaffolded with SQLite, Tailwind CSS, Hotwire (Turbo + Stimulus), and Importmap
- Sign up (`/registration/new`), log in (`/session/new`), and log out flows
- Built-in Rails 8 authentication (no Devise) — `rails generate authentication` + manual `RegistrationsController`
- Board CRUD: create, list, edit, delete; boards index is the authenticated root (`/`)
- Boards are user-scoped — only the owner can view, edit, or delete their boards
- Board name presence validation (model + controller)
- Flash messages for create/update/delete actions
- `AGENTS.md`, `README.md` created; `CLAUDE.md` updated with AGENTS.md instruction block

### How to Run It
```bash
export PATH="/usr/local/lib/ruby/gems/3.4.0/bin:/usr/local/opt/ruby/bin:$PATH"
bin/setup --skip-server   # install gems, prepare DB, npm install
bin/rails server          # start at http://localhost:3000
```
Visit `http://localhost:3000`, sign up with an email and password, and start creating boards. You'll see a card grid of your boards with Edit and Delete links on each card.

### Review Findings
- **MUST-FIX resolved — SimpleCov parallelization**: `parallelize(workers: :number_of_processors)` caused SimpleCov to under-report coverage. Fixed by switching to `parallelize(workers: 1)`. Coverage now correctly reports 82.31%.
- **MUST-FIX resolved — DB null constraint**: `boards.name` was nullable at the DB level despite model validation. Added migration `add_not_null_to_boards` to enforce `null: false` at the database layer.
- **Fixed — `User.take` non-determinism**: `sessions_controller_test.rb` changed from `User.take` to `users(:one)` for stable fixture selection.
- **Fixed — missing negative sign-up assertion**: Added `assert_not User.exists?` to the mismatched-password test.
- **Fixed — boards index missing negative scope assertion**: Added second-user board to fixture and `assert_no_match` to verify scoping.
- **Fixed — E2E login URL assertion**: Added `toHaveURL('/boards')` to the login success test.
- **Deferred — `before_action :require_authentication` implicit**: `ApplicationController` relies on implicit behavior from the `Authentication` concern rather than declaring it explicitly. Functionally correct but noted for Phase 2.
- **Deferred — `show` action out of scope**: A `GET /boards/:id` route and view were added outside Phase 1 scope with no authorization test. Phase 2 will promote this to the full board canvas for swimlanes.
- **Deferred — whitespace board names pass validation**: `presence: true` allows `"   "`. Noted for future attention.

### What's Next
- **Phase 2**: Swimlane (column) model + Card model, board show page as the main canvas, Swimlane CRUD, Card CRUD, drag-and-drop reordering with SortableJS
- Promote the `show` action into a real board detail page where swimlanes will live
- Add explicit `before_action :require_authentication` to `ApplicationController`
- Add authorization test for the `show` action
- Commit per task (not per phase) going forward

### Test Coverage
- **Command**: `bin/rails test`
- **Result**: 30 runs, 71 assertions, **0 failures, 0 errors, 0 skips**
- **Coverage**: **82.31%** line coverage (107/130 lines) — above the 80% minimum threshold
- **Tests added this phase**:
  - `test/models/user_test.rb` — email presence, uniqueness
  - `test/models/board_test.rb` — name presence, user association required
  - `test/controllers/sessions_controller_test.rb` — login success/failure
  - `test/integration/authentication_flow_test.rb` — sign up, sign in, invalid credentials, unauthenticated redirect, log out
  - `test/integration/boards_flow_test.rb` — create, blank name error, edit, delete, cross-user access denial, index scoping
  - `e2e/auth.spec.js` — sign up → boards, log out → login, unauthenticated redirect
  - `e2e/boards.spec.js` — create board, edit board name, delete board
- **Not yet covered**: `show` action authorization, sign-up with duplicate email (HTTP flow), whitespace-only board names

---

## Phase 2: Swimlanes and Cards with Drag-and-Drop

### What We Built
- `Swimlane` model (`name`, `position`, `board_id`) with DB-enforced not-null constraints and whitespace-stripping validation
- `Card` model (`name`, `position`, `swimlane_id`) with the same validation pattern
- Full board canvas at `GET /boards/:id` — displays board name, all swimlane columns in order, and all cards in each lane in order
- Swimlane CRUD (create, rename, delete) via Turbo Streams — no full-page reload; new lane appears immediately; delete cascades to all its cards
- Card CRUD (create, rename, delete) via Turbo Streams — inline interaction within each lane
- Drag-and-drop card reordering with SortableJS: drag within a lane to reorder, drag to another lane to move; positions persisted via `PATCH /boards/:board_id/swimlanes/:swimlane_id/cards/reorder`
- All swimlane and card routes nested under `/boards/:board_id`; authorization chain scopes through `Current.user.boards` — wrong-owner requests return 404
- Explicit `before_action :require_authentication` added to `ApplicationController` (Phase 1 tech debt)
- Board name whitespace-stripping validation added (Phase 1 tech debt)
- SortableJS pinned via importmap CDN; Stimulus `sortable_controller.js` handles `onEnd` event and sends PATCH
- Shared Playwright auth helpers extracted to `e2e/helpers/auth.js` — used across all E2E specs

### How to Run It
```bash
export PATH="/usr/local/lib/ruby/gems/3.4.0/bin:/usr/local/opt/ruby/bin:$PATH"
bin/setup --skip-server   # install gems, prepare DB, npm install
bin/rails server          # start at http://localhost:3000
```
Sign up, create a board, navigate to the board. You'll see a horizontal lane layout — click "Add Lane" to create columns, then "Add Card" within any lane to add cards. Click a card or lane name to rename inline. Drag cards between lanes or within a lane to reorder.

### Review Findings
- **Fixed — boards#show auth test missing**: Integration test added in `b3f839a` covering authenticated access and 404 for cross-user boards.
- **Open — Ruby-level sort bypasses DB ordering**: `swimlane.cards.sort_by(&:position)` in the swimlane partial sorts an already-loaded relation in Ruby instead of using SQL ordering. Functionally correct but inconsistent with the established `.order(:position)` pattern. Fix deferred to Phase 3.
- **Open — reorder action missing bounds guard**: `Array#insert` at position > array length pads with `nil`, causing `NoMethodError` on a raw PATCH with a large `position` value. A `position.clamp(0, cards.length - 1)` guard is needed. Deferred to Phase 3.
- **Open — swimlane partial uses `<div>` not `turbo_frame_tag`**: The PLAN specified wrapping swimlane headers in `turbo_frame_tag dom_id(swimlane)`, but the implementation uses a plain `<div>`. The Cancel link on the rename form consequently loads the full board page into the frame rather than restoring the header. Deferred to Phase 3.
- **Open — new swimlane appends after "Add Lane" button**: `turbo_stream.append "swimlanes"` places new lanes after the form column because the button is the last child of `#swimlanes`. New lanes appear to the right of the input. Deferred to Phase 3.
- **Open — E2E drag tests use `fetch` not DOM drag**: Playwright drag tests call the PATCH endpoint directly rather than simulating a real SortableJS drag. Tests the server but not the Stimulus controller, SortableJS initialization, or CSRF token handling. Deferred to Phase 3.

### What's Next
- **Phase 3 carry-over fixes first**: (1) `turbo_frame_tag` wrapper + cancel link, (2) reorder bounds guard, (3) new-swimlane append order, (4) SQL ordering on card association
- **Phase 3 feature**: Card details — clicking a card opens an expanded view with description, due date, and color-coded labels
- Establish DOM-level Playwright drag test using `page.dragAndDrop()` or the `mouse` API
- Add E2E coverage for swimlane and card rename flows

### Test Coverage
- **Command**: `bin/rails test`
- **Result**: 73 runs, 171 assertions, **0 failures, 0 errors, 0 skips**
- **Coverage**: **86.19%** line coverage (206/239 lines) — above the 80% minimum threshold
- **Tests added this phase**:
  - `test/models/swimlane_test.rb` — name validation, position scoping, cascade destroy
  - `test/models/card_test.rb` — name validation, position scoping, association
  - `test/integration/swimlanes_flow_test.rb` — CRUD (HTML + Turbo Stream), cross-user 404, whitespace name rejection
  - `test/integration/cards_flow_test.rb` — CRUD via Turbo Streams, cross-user 404
  - `test/integration/cards_reorder_test.rb` — reorder within lane, cross-lane move, cross-user 404, unauthenticated redirect
  - `test/integration/boards_flow_test.rb` — extended with `boards#show` auth test
  - `e2e/board_canvas.spec.js` — create/delete swimlane, create/delete card, drag card (via PATCH stub)
- **Known gaps**:
  - Reorder with out-of-bounds `position` (no guard, no test)
  - Cascade destroy test uses only 1 card — a 2-card assertion would be unambiguous
  - E2E: rename swimlane and card inline edit flows not covered
  - E2E: actual DOM drag interaction not tested (only server-side PATCH stub)

---
