# Project Status

> Auto-generated by cc-pipeline. Last updated after Phase 3.

## Overview
Swimlanes is a Trello-like board management app built with Rails 8, Hotwire (Turbo + Stimulus), Tailwind CSS, and SQLite. Users will be able to create boards with swimlane columns and draggable cards, with card details, board sharing, real-time updates, and customizable backgrounds.

**Current state:** Users can sign up, log in, create boards, and manage a full board canvas. Each board has swimlane columns that can be added, renamed, and deleted. Cards can be created in any lane, renamed, deleted, and dragged to reorder within a lane or moved to a different lane — with order persisting after reload. Clicking a card opens a detail modal where users can add a description, set a due date, and attach color-coded labels (red, yellow, green, blue, purple). The card face updates immediately to show description indicators, due date badges (overdue cards shown in red), and label color chips. All actions are authentication-gated and scoped to the board owner.

---

## Phase 1: Project Setup, Authentication, and Board CRUD

### What We Built
- Rails 8 app scaffolded with SQLite, Tailwind CSS, Hotwire (Turbo + Stimulus), and Importmap
- Sign up (`/registration/new`), log in (`/session/new`), and log out flows
- Built-in Rails 8 authentication (no Devise) — `rails generate authentication` + manual `RegistrationsController`
- Board CRUD: create, list, edit, delete; boards index is the authenticated root (`/`)
- Boards are user-scoped — only the owner can view, edit, or delete their boards
- Board name presence validation (model + controller)
- Flash messages for create/update/delete actions
- `AGENTS.md`, `README.md` created; `CLAUDE.md` updated with AGENTS.md instruction block

### How to Run It
```bash
export PATH="/usr/local/lib/ruby/gems/3.4.0/bin:/usr/local/opt/ruby/bin:$PATH"
bin/setup --skip-server   # install gems, prepare DB, npm install
bin/rails server          # start at http://localhost:3000
```
Visit `http://localhost:3000`, sign up with an email and password, and start creating boards. You'll see a card grid of your boards with Edit and Delete links on each card.

### Review Findings
- **MUST-FIX resolved — SimpleCov parallelization**: `parallelize(workers: :number_of_processors)` caused SimpleCov to under-report coverage. Fixed by switching to `parallelize(workers: 1)`. Coverage now correctly reports 82.31%.
- **MUST-FIX resolved — DB null constraint**: `boards.name` was nullable at the DB level despite model validation. Added migration `add_not_null_to_boards` to enforce `null: false` at the database layer.
- **Fixed — `User.take` non-determinism**: `sessions_controller_test.rb` changed from `User.take` to `users(:one)` for stable fixture selection.
- **Fixed — missing negative sign-up assertion**: Added `assert_not User.exists?` to the mismatched-password test.
- **Fixed — boards index missing negative scope assertion**: Added second-user board to fixture and `assert_no_match` to verify scoping.
- **Fixed — E2E login URL assertion**: Added `toHaveURL('/boards')` to the login success test.
- **Deferred — `before_action :require_authentication` implicit**: `ApplicationController` relies on implicit behavior from the `Authentication` concern rather than declaring it explicitly. Functionally correct but noted for Phase 2.
- **Deferred — `show` action out of scope**: A `GET /boards/:id` route and view were added outside Phase 1 scope with no authorization test. Phase 2 will promote this to the full board canvas for swimlanes.
- **Deferred — whitespace board names pass validation**: `presence: true` allows `"   "`. Noted for future attention.

### What's Next
- **Phase 2**: Swimlane (column) model + Card model, board show page as the main canvas, Swimlane CRUD, Card CRUD, drag-and-drop reordering with SortableJS
- Promote the `show` action into a real board detail page where swimlanes will live
- Add explicit `before_action :require_authentication` to `ApplicationController`
- Add authorization test for the `show` action
- Commit per task (not per phase) going forward

### Test Coverage
- **Command**: `bin/rails test`
- **Result**: 30 runs, 71 assertions, **0 failures, 0 errors, 0 skips**
- **Coverage**: **82.31%** line coverage (107/130 lines) — above the 80% minimum threshold
- **Tests added this phase**:
  - `test/models/user_test.rb` — email presence, uniqueness
  - `test/models/board_test.rb` — name presence, user association required
  - `test/controllers/sessions_controller_test.rb` — login success/failure
  - `test/integration/authentication_flow_test.rb` — sign up, sign in, invalid credentials, unauthenticated redirect, log out
  - `test/integration/boards_flow_test.rb` — create, blank name error, edit, delete, cross-user access denial, index scoping
  - `e2e/auth.spec.js` — sign up → boards, log out → login, unauthenticated redirect
  - `e2e/boards.spec.js` — create board, edit board name, delete board
- **Not yet covered**: `show` action authorization, sign-up with duplicate email (HTTP flow), whitespace-only board names

---

## Phase 2: Swimlanes and Cards with Drag-and-Drop

### What We Built
- `Swimlane` model (`name`, `position`, `board_id`) with DB-enforced not-null constraints and whitespace-stripping validation
- `Card` model (`name`, `position`, `swimlane_id`) with the same validation pattern
- Full board canvas at `GET /boards/:id` — displays board name, all swimlane columns in order, and all cards in each lane in order
- Swimlane CRUD (create, rename, delete) via Turbo Streams — no full-page reload; new lane appears immediately; delete cascades to all its cards
- Card CRUD (create, rename, delete) via Turbo Streams — inline interaction within each lane
- Drag-and-drop card reordering with SortableJS: drag within a lane to reorder, drag to another lane to move; positions persisted via `PATCH /boards/:board_id/swimlanes/:swimlane_id/cards/reorder`
- All swimlane and card routes nested under `/boards/:board_id`; authorization chain scopes through `Current.user.boards` — wrong-owner requests return 404
- Explicit `before_action :require_authentication` added to `ApplicationController` (Phase 1 tech debt)
- Board name whitespace-stripping validation added (Phase 1 tech debt)
- SortableJS pinned via importmap CDN; Stimulus `sortable_controller.js` handles `onEnd` event and sends PATCH
- Shared Playwright auth helpers extracted to `e2e/helpers/auth.js` — used across all E2E specs

### How to Run It
```bash
export PATH="/usr/local/lib/ruby/gems/3.4.0/bin:/usr/local/opt/ruby/bin:$PATH"
bin/setup --skip-server   # install gems, prepare DB, npm install
bin/rails server          # start at http://localhost:3000
```
Sign up, create a board, navigate to the board. You'll see a horizontal lane layout — click "Add Lane" to create columns, then "Add Card" within any lane to add cards. Click a card or lane name to rename inline. Drag cards between lanes or within a lane to reorder.

### Review Findings
- **Fixed — boards#show auth test missing**: Integration test added in `b3f839a` covering authenticated access and 404 for cross-user boards.
- **Open — Ruby-level sort bypasses DB ordering**: `swimlane.cards.sort_by(&:position)` in the swimlane partial sorts an already-loaded relation in Ruby instead of using SQL ordering. Functionally correct but inconsistent with the established `.order(:position)` pattern. Fix deferred to Phase 3.
- **Open — reorder action missing bounds guard**: `Array#insert` at position > array length pads with `nil`, causing `NoMethodError` on a raw PATCH with a large `position` value. A `position.clamp(0, cards.length - 1)` guard is needed. Deferred to Phase 3.
- **Open — swimlane partial uses `<div>` not `turbo_frame_tag`**: The PLAN specified wrapping swimlane headers in `turbo_frame_tag dom_id(swimlane)`, but the implementation uses a plain `<div>`. The Cancel link on the rename form consequently loads the full board page into the frame rather than restoring the header. Deferred to Phase 3.
- **Open — new swimlane appends after "Add Lane" button**: `turbo_stream.append "swimlanes"` places new lanes after the form column because the button is the last child of `#swimlanes`. New lanes appear to the right of the input. Deferred to Phase 3.
- **Open — E2E drag tests use `fetch` not DOM drag**: Playwright drag tests call the PATCH endpoint directly rather than simulating a real SortableJS drag. Tests the server but not the Stimulus controller, SortableJS initialization, or CSRF token handling. Deferred to Phase 3.

### What's Next
- **Phase 3 carry-over fixes first**: (1) `turbo_frame_tag` wrapper + cancel link, (2) reorder bounds guard, (3) new-swimlane append order, (4) SQL ordering on card association
- **Phase 3 feature**: Card details — clicking a card opens an expanded view with description, due date, and color-coded labels
- Establish DOM-level Playwright drag test using `page.dragAndDrop()` or the `mouse` API
- Add E2E coverage for swimlane and card rename flows

### Test Coverage
- **Command**: `bin/rails test`
- **Result**: 73 runs, 171 assertions, **0 failures, 0 errors, 0 skips**
- **Coverage**: **86.19%** line coverage (206/239 lines) — above the 80% minimum threshold
- **Tests added this phase**:
  - `test/models/swimlane_test.rb` — name validation, position scoping, cascade destroy
  - `test/models/card_test.rb` — name validation, position scoping, association
  - `test/integration/swimlanes_flow_test.rb` — CRUD (HTML + Turbo Stream), cross-user 404, whitespace name rejection
  - `test/integration/cards_flow_test.rb` — CRUD via Turbo Streams, cross-user 404
  - `test/integration/cards_reorder_test.rb` — reorder within lane, cross-lane move, cross-user 404, unauthenticated redirect
  - `test/integration/boards_flow_test.rb` — extended with `boards#show` auth test
  - `e2e/board_canvas.spec.js` — create/delete swimlane, create/delete card, drag card (via PATCH stub)
- **Known gaps**:
  - Reorder with out-of-bounds `position` (no guard, no test)
  - Cascade destroy test uses only 1 card — a 2-card assertion would be unambiguous
  - E2E: rename swimlane and card inline edit flows not covered
  - E2E: actual DOM drag interaction not tested (only server-side PATCH stub)

---

## Phase 3: Card Details — Descriptions, Due Dates, and Labels

### What We Built
- **Card detail modal**: clicking a card title opens a `<dialog>` detail view via Turbo Frame (`card_N_detail`) — no full-page reload
- **Card description**: free-text textarea on the detail view; saves via Turbo Stream; card face shows a description indicator (`≡`) when one is present
- **Due dates**: date input on the detail view; card face shows a formatted date badge (e.g., "Feb 18"); overdue cards (past due date) show a red badge
- **Color-coded labels**: 5 predefined labels (red, yellow, green, blue, purple) toggled via checkboxes; selected labels appear as color chips on the card face; labels stored in a `labels` table with a `card_labels` join table
- **`Card` model** updated: added `description` (text, nullable), `due_date` (date, nullable), `overdue?` method, `overdue` and `upcoming` scopes, `has_many :labels through: :card_labels`
- **`Label` model** (new): `color` string with inclusion validation; COLORS constant; unique index on color; seeded via `bin/rails db:seed`
- **`CardLabel` join model** (new): `card_id` and `label_id` FK references with unique composite index
- **DB-level card ordering**: `has_many :cards, -> { order(:position) }` scope on `Swimlane` — Ruby-side `sort_by` anti-pattern eliminated
- **N+1 fix**: `BoardsController#show` now uses `includes(cards: :labels)` to batch-load labels
- **E2E drag test replaced**: `board_canvas.spec.js` drag test now uses Playwright `dragAndDrop()` on real DOM elements and asserts card order changed (no more `fetch` stub)
- **Cards reorder clamp guard** confirmed in place: `position.clamp(0, ...)` prevents `NoMethodError` on out-of-range values
- Close button on card detail navigates Turbo Frame back to the empty board state
- AGENTS.md and README.md updated to document Label, CardLabel, card detail route, and Phase 3 features

### How to Run It
```bash
export PATH="/usr/local/lib/ruby/gems/3.4.0/bin:/usr/local/opt/ruby/bin:$PATH"
bin/setup --skip-server   # install gems, prepare DB, npm install
bin/rails db:seed         # creates 5 predefined labels (run once)
bin/rails server          # start at http://localhost:3000
```
Sign up, create a board, add a swimlane and a card. Click the card title — a modal opens where you can add a description, pick a due date, and toggle color labels. Close the modal and the card face shows description indicator, date badge, and label chips.

### Review Findings
- **MUST-FIX resolved — Description/due-date forms used `_top` navigation**: Both forms had `data: { turbo_frame: "_top" }`, causing full-page reloads instead of Turbo Stream updates (spec violation). Fixed by removing that attribute — forms now stay in frame context and route through `format.turbo_stream`.
- **MUST-FIX resolved — E2E drag assertion was vacuous**: `toHaveCount(2)` confirmed cards still existed but did not verify order changed. Fixed by asserting `secondIdx < firstIdx` using `allTextContents()` — confirms the card actually moved.
- **MUST-FIX resolved — Overdue badge integration test was too shallow**: Test only asserted model state (`card.reload.overdue?`). Fixed by adding `assert_match "overdue", response.body` to verify the rendered Turbo Stream HTML includes the overdue CSS class.
- **Open — Close button uses inline JS**: The close button in `show.html.erb` uses a raw `onclick` with `removeChild` DOM manipulation. Works but fragile if Turbo Frame structure changes. A small Stimulus action would be more maintainable. Deferred to Phase 4.
- **Open — README Phase 3 entry missing `✓` checkmark**: Minor cosmetic inconsistency with Phase 1 and 2 entries. Deferred.
- **Open — Upcoming scope today boundary not tested**: `upcoming` scope uses `due_date >= Date.current` but there is no test asserting a card due today appears in `upcoming`. Deferred.
- **Open — No `assert_queries` guard for N+1 regression**: The label N+1 fix was applied but there's no test that would catch a regression. Deferred.

### What's Next
- **Phase 4**: Board sharing between users — allow owners to invite collaborators; shared boards visible in invitee's boards index
- Deferred from Phase 3: Stimulus dialog close action, README checkmark cleanup, upcoming-scope boundary test, N+1 regression guard
- Checklists / checklist items (originally deferred from Phase 3 scope)
- Label chip on card face close button inline JS refactor

### Test Coverage
- **Command**: `bin/rails test`
- **Result**: 89 runs, 212 assertions, **0 failures, 0 errors, 0 skips**
- **Coverage**: **87.06%** line coverage (222/255 lines) — above the 80% minimum threshold
- **Tests added this phase**:
  - `test/models/card_test.rb` — `overdue?` method (past/today/future/nil), `overdue` scope, `upcoming` scope
  - `test/models/label_test.rb` (new) — valid/invalid colors, uniqueness constraint, COLORS constant
  - `test/integration/cards_flow_test.rb` — card show (auth + cross-user 404), description update (Turbo Stream), due date update (overdue CSS in response body), label add/remove
  - `e2e/board_canvas.spec.js` — drag reorder replaced with real `dragAndDrop()` + DOM order assertion
  - `e2e/card_detail.spec.js` (new) — open detail modal, add description (card face indicator), set future due date (badge), set past due date (overdue red badge), toggle label on/off (chip appears/disappears)
- **Known gaps**:
  - `upcoming` scope: no boundary test for cards due today
  - No `assert_queries` or Bullet guard to catch N+1 regression on label loading
  - Invalid label ID parameter handling (Rails silently ignores — not tested)
  - No integration test asserting Turbo Stream response body includes label chip HTML on label save

---
